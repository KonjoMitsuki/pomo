# Discord ポモドーロタイマー Bot

Discordのボイスチャンネルで動作するポモドーロタイマーボットです。標準的なポモドーロテクニック（作業→小休憩→作業→...→長休憩）に対応し、作業時間の記録、一時停止・再開機能、タイマー終了時の音声通知機能を備えています。

## 特徴

- **標準的なポモドーロテクニック対応**: 4セッションごとに自動的に長休憩
- **参加ボタン**: 他のユーザーが🙋参加 / 👋退出ボタンでタイマーに参加・退出できる
- **起動者退出後も継続**: 起動者がVCを抜けても参加者がいればタイマーは継続
- **完全カスタマイズ可能**: 作業時間、小休憩、長休憩、長休憩の頻度をすべて設定可能
- **音声通知**: 各セッション終了時に音声で通知
- **統計機能**: 累計作業時間とセッション数を記録・表示
- **タイマー情報**: 現在のタイマー設定、進捗、参加者ごとの作業時間を確認可能
- **リアルタイム制御**: 起動者・参加者が一時停止・再開・終了ボタンで操作
- **自動退出検知**: 参加者がVCから退出すると自動的にタイマー対象から除外

## 必要なもの

### ファイル

- `timer.py` - メインプログラム
- `ding.mp3` - 通知音（同じディレクトリに配置）
- `pomo.db` - 統計データベース（自動生成）

### 依存ライブラリ

```bash
pip install discord.py aiosqlite
```

### FFmpeg（音声再生に必要）

```bash
# Ubuntu/Debian
sudo apt install ffmpeg

# macOS
brew install ffmpeg

# Windows
# https://ffmpeg.org/download.html からダウンロード
```

## セットアップ

### 1. 環境変数の設定

Discordボットトークンを環境変数に設定します。

**方法1: 一時的に設定（そのターミナルセッションのみ有効）**

```bash
export DISCORD_BOT_TOKEN='your_token_here'
```

**方法2: 永続的に設定（推奨）**

```bash
# bashの場合
echo "export DISCORD_BOT_TOKEN='your_token_here'" >> ~/.bashrc
source ~/.bashrc

# zshの場合
echo "export DISCORD_BOT_TOKEN='your_token_here'" >> ~/.zshrc
source ~/.zshrc
```

**方法3: .envファイルを使用**

```bash
# .env ファイルを作成
echo "DISCORD_BOT_TOKEN=your_token_here" > .env

# python-dotenvをインストール
pip install python-dotenv
```

### 2. ボットの起動

```bash
python timer.py
```

起動成功時のメッセージ:

```
〜としてログインしました。
```

## 使い方

### コマンド一覧

#### `!pomo` - ポモドーロタイマー開始

**基本構文:**

```
!pomo [作業時間] [小休憩] [長休憩] [長休憩頻度]
```

**パラメータ:**

1. 作業時間（分）- デフォルト: 25
2. 小休憩時間（分）- デフォルト: 5
3. 長休憩時間（分）- デフォルト: 15
4. 長休憩の頻度（セッション数）- デフォルト: 4

**使用例:**

```bash
!pomo                    # 25分作業、5分小休憩、15分長休憩、4回ごと
!pomo 50                 # 50分作業、他はデフォルト
!pomo 50 10              # 50分作業、10分小休憩、他はデフォルト
!pomo 50 10 20           # 50分作業、10分小休憩、20分長休憩
!pomo 50 10 20 3         # 50分作業、10分小休憩、20分長休憩、3回ごと
!pomo 1 1 1 2            # テスト用: 1分ずつ、2回ごとに長休憩
```

**動作:**

1. ボイスチャンネルに参加してからコマンド実行
2. ボットが自動的にボイスチャンネルに接続
3. コントロールメッセージに🙋参加 / 👋退出ボタンが表示される
4. 作業セッション開始
5. セッション終了時に音声通知 → 休憩タイマー自動開始
6. 休憩終了時に音声通知 → 次のセッションを自動開始
7. 4回目（または指定回数）のセッション後は長休憩
8. 全員がボイスチャンネルから退出するまで継続

#### `!timer` - タイマー情報表示

現在のタイマーの詳細情報を表示します。

```bash
!timer
```

**表示内容:**

- タイマー設定（作業時間、小休憩、長休憩、長休憩頻度）
- 完了セッション数と合計作業時間
- 参加者一覧と各参加者の今回のタイマーでの作業時間

#### `!add @user` - 参加者追加

指定ユーザーをタイマー対象に追加します。参加ボタンからも追加できます。

```bash
!add @username
```

#### `!remove @user` - 参加者削除

指定ユーザーを加算対象から削除します。

```bash
!remove @username
```

#### `!list` - 参加者一覧

現在の加算対象ユーザー一覧を表示します。

```bash
!list
```

#### `!stats` - 統計表示

自分の累計作業時間と完了セッション数を表示します。

```bash
!stats
```

#### `!reset` - 統計リセット

自分の累計作業時間と完了セッション数をリセットします。

```bash
!reset
```

#### `!test` - 音声テスト

音声通知が正しく再生されるかテストします。

```bash
!test
```

#### `!help` - ヘルプ表示

コマンド一覧を表示します。

```bash
!help
```

### 参加機能

タイマー開始時に表示されるコントロールメッセージの🙋参加 / 👋退出ボタンから、他のユーザーがタイマーに参加・退出できます。

- **参加**: ボタンを押すとタイマー対象に追加され、セッション完了時に作業時間が記録される
- **退出**: ボタンを押すとタイマー対象から除外される
- **VC退出時の自動除外**: 参加者がボイスチャンネルから退出すると自動的にタイマー対象から除外される
- **起動者退出後の継続**: 起動者がVCを抜けても、参加者がVCに残っていればタイマーは継続する

### タイマー操作

タイマー中のメッセージに表示されるボタンで操作できます:

- **⏸️ 一時停止** - タイマーを一時停止（カウントダウンを停止）
- **▶️ 再開** - 一時停止したタイマーを再開
- **⏹️ 終了** - タイマーを終了してボイスチャンネルから退出

起動者と参加者の両方がボタンを操作できます。

### 終了方法

ポモドーロを終了するには以下の方法があります:

1. **⏹️ 終了ボタンをクリック** - 手動で即座に終了
2. **全員がボイスチャンネルから退出** - 自動的に終了

タイマー終了時に参加者リストは自動的にクリアされます。

## 動作フロー

### 標準的なポモドーロサイクル

```
セッション1 (25分) → 音声通知 → 小休憩 (5分) → 音声通知
    ↓
セッション2 (25分) → 音声通知 → 小休憩 (5分) → 音声通知
    ↓
セッション3 (25分) → 音声通知 → 小休憩 (5分) → 音声通知
    ↓
セッション4 (25分) → 音声通知 → 長休憩 (15分) → 音声通知
    ↓
セッション5 (25分) → ...（継続）
```

### 詳細フロー

1. ユーザーが`!pomo`コマンドを実行
2. ボットがボイスチャンネルに接続
3. コントロールメッセージ（参加/退出ボタン付き）を表示
4. 作業タイマー開始（1分ごとにメッセージ更新）
5. 作業完了時:
   - データベースに記録（VCにいる参加者のみ）
   - 音声通知を再生（ding.mp3）
6. 自動的に休憩タイマー開始
   - 4の倍数セッション後 → 長休憩
   - それ以外 → 小休憩
7. 休憩完了時:
   - 音声通知を再生
8. 2秒待機後、次のセッションを自動開始
9. 起動者または参加者がボイスチャンネルにいる限り継続

## データベース構造

SQLiteデータベース（`pomo.db`）にユーザーごとの統計を保存します。

```sql
CREATE TABLE stats (
    user_id INTEGER PRIMARY KEY,
    total_minutes INTEGER DEFAULT 0,
    sessions INTEGER DEFAULT 0
)
```

- `user_id`: DiscordユーザーID
- `total_minutes`: 累計作業時間（分）
- `sessions`: 完了セッション数

## トラブルシューティング

### 音声が聞こえない・再生されない

**1. FFmpegがインストールされているか確認**

```bash
ffmpeg -version
```

**2. ding.mp3ファイルが存在するか確認**

```bash
ls -l ding.mp3
```

**3. テストコマンドで音声再生をテスト**

```bash
!test
```

このコマンドで音声が聞こえるか確認してください。

**4. ボットがボイスチャンネルに正しく接続されているか確認**

- Discordでボットがボイスチャンネルに参加しているか確認
- ボット側のログに接続エラーがないか確認

**5. 音量設定を調整**
音が小さい場合は、`timer.py`の音量設定を変更できます:

```python
options='-filter:a "volume=2.0"'  # 2.0を3.0や4.0に変更
```

### ボットが起動しない

**1. 環境変数が設定されているか確認**

```bash
echo $DISCORD_BOT_TOKEN
```

何も表示されない場合は環境変数が設定されていません。

**2. トークンが正しいか確認**
Discord Developer Portalでトークンを確認してください。

**3. 依存ライブラリがインストールされているか確認**

```bash
pip list | grep discord
pip list | grep aiosqlite
```

### タイマーが途中で止まる

**1. ネットワーク接続を確認**
不安定なネットワークではタイムアウトする可能性があります。

**2. ボットのログを確認**
ターミナルにエラーメッセージが表示されていないか確認してください。

## 制限事項

- 音声通知にはボイスチャンネル接続とFFmpegが必須
- メッセージ更新はAPI制限回避のため1分ごと
- セッションは自動継続するため、終了時は明示的な操作が必要
- 複数ユーザーが同時に異なる設定でタイマーを使用することも可能

## セキュリティに関する注意

### トークンの管理

- **環境変数で管理**: ボットトークンは必ず環境変数で管理してください
- **コードに直接書かない**: トークンをコードに直接書くと、Gitにコミットした際に漏洩します
- **`.env`ファイルの秘匿**: `.env`ファイルを使用する場合は、必ず`.gitignore`に追加してください

```bash
# .gitignore に追加
echo ".env" >> .gitignore
```

### トークンが漏洩した場合

1. Discord Developer Portalにアクセス
2. 該当するボットのトークンを再生成
3. 環境変数を新しいトークンに更新

## カスタマイズ

### 音量を調整する

`timer.py`の音量設定を変更できます:

```python
# 作業完了時の音声
options='-filter:a "volume=1.0"'

# 休憩完了時の音声
options='-filter:a "volume=1.5"'
```

`volume=`の数値を変更:

- `1.0` - 元の音量
- `2.0` - 2倍
- `3.0` - 3倍
- `0.5` - 半分

### 通知音を変更する

`ding.mp3`を別の音声ファイルに置き換えるか、`timer.py`の`SOUND_FILE`変数を変更:

```python
SOUND_FILE = "your_sound.mp3"
```

### デフォルト設定を変更する

コマンドのデフォルト値を変更できます:

```python
async def pomo(ctx, work_minutes: int = 25, short_break: int = 5, long_break: int = 15, long_break_interval: int = 4):
```

例: デフォルトを50分作業に変更

```python
async def pomo(ctx, work_minutes: int = 50, short_break: int = 10, long_break: int = 20, long_break_interval: int = 4):
```

## ライセンスと免責事項

このボットは教育目的で作成されています。使用は自己責任でお願いします。

---

**作成日**: 2025年2月
**バージョン**: 3.0
